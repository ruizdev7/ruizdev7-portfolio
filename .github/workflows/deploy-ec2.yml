name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version/tag to deploy
        id: set_version
        run: |
          TAG=$(git describe --tags --exact-match 2>/dev/null || echo ${{ github.sha }})
          echo "VERSION_TAG=$TAG" >> $GITHUB_ENV
          echo "üöÄ Deploying version: $TAG"

      - name: Setup SSH key properly
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Escribir la llave usando printf para interpretar \n correctamente
          printf '%b\n' "${{ secrets.EC2_SSH_KEY_PORTFOLIO }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verificar formato y contar l√≠neas
          echo "üîç Verificando formato de la llave..."
          LINES=$(wc -l < ~/.ssh/deploy_key)
          echo "L√≠neas detectadas: $LINES"
          
          if head -1 ~/.ssh/deploy_key | grep -q "BEGIN"; then
            echo "‚úÖ Formato correcto detectado"
            head -1 ~/.ssh/deploy_key
            tail -1 ~/.ssh/deploy_key
          else
            echo "‚ùå ERROR: Formato de llave inv√°lido"
            echo "La llave debe comenzar con -----BEGIN ... KEY-----"
            echo "Contenido detectado (primeras 100 chars):"
            head -c 100 ~/.ssh/deploy_key
            exit 1
          fi
          
          # Configurar SSH config
          cat > ~/.ssh/config << EOF
          Host ec2-deploy
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          ssh ec2-deploy "echo '‚úÖ Conexi√≥n SSH exitosa'"

      - name: Deploy to EC2
        run: |
          ssh ec2-deploy bash << 'ENDSSH'
            set -e
            
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            cd /home/ubuntu/Documents/Github/ruizdev7-portfolio
            
            echo "üìù Updating docker-compose.yml to version: ${{ env.VERSION_TAG }}"
            sed -i "s|portfolio-backend:REPLACE_TAG|portfolio-backend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            sed -i "s|portfolio-frontend:REPLACE_TAG|portfolio-frontend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            sed -i "s|portfolio-backend:[a-f0-9]\{7,40\}|portfolio-backend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            sed -i "s|portfolio-frontend:[a-f0-9]\{7,40\}|portfolio-frontend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            
            echo "üì• Pulling new images..."
            docker compose pull backend frontend
            
            echo "üîÑ Restarting services..."
            docker compose up -d backend frontend
            
            echo "‚úÖ Deployment complete!"
            docker compose ps
          ENDSSH