name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version/tag to deploy
        id: set_version
        run: |
          TAG=$(git describe --tags --exact-match 2>/dev/null || echo ${{ github.sha }})
          echo "VERSION_TAG=$TAG" >> $GITHUB_ENV
          echo "üöÄ Deploying version: $TAG"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY_PORTFOLIO }}
          script: |
            set -e
            
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            cd /home/ubuntu/Documents/Github/ruizdev7-portfolio
            
            echo "üìù Updating docker-compose.yml to version: ${{ env.VERSION_TAG }}"
            sed -i "s|portfolio-backend:REPLACE_TAG|portfolio-backend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            sed -i "s|portfolio-frontend:REPLACE_TAG|portfolio-frontend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            sed -i "s|portfolio-backend:[a-f0-9]\{7,40\}|portfolio-backend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            sed -i "s|portfolio-frontend:[a-f0-9]\{7,40\}|portfolio-frontend:${{ env.VERSION_TAG }}|g" docker-compose.yml
            
            echo "üì• Pulling new images..."
            docker compose pull backend frontend
            
            echo "üîÑ Restarting services..."
            docker compose up -d backend frontend
            
            echo "‚úÖ Deployment complete!"
            docker compose ps